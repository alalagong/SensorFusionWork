# SensorFusion第四节作业

## Jacobian推导

参考代码中的建模，有：
$$
\boldsymbol X_{u}=\mathbf T \cdot \mathbf K\cdot (\boldsymbol X-\mathbf B) \tag{1}
$$
其中$\boldsymbol X_u$表示矫正之后的加速度数据，$\boldsymbol X$表示读取的原始数据，且
$$
\mathbf T=
\begin{bmatrix}
1   & 0 & 0 \\
t_1 & 1 & 0 \\
-t_2 & t_3 & 1\\
\end{bmatrix} \quad 
\mathbf K = 
\begin{bmatrix}
s_1 & & \\
&s_2& \\
&&s_3
\end{bmatrix}
\quad \mathbf B=
\begin{bmatrix}
b_1\\
b_2\\
b_3
\end{bmatrix}
$$
展开有
$$
\begin{aligned}
x_u&= s_1(x-b_1) \\
y_u&= s_1t_1(x-b_1)+s_2(y-b_2)  \\
z_u&= -s_1t_2(x-b_1)+s_2t_3(y-b_2)   +s_3(z-b_3)
\end{aligned} \tag{2}
$$
残差函数有
$$
{r} = \|\boldsymbol g\|^2-\|\boldsymbol  X_u\|^2 \tag{3}
$$

应用链式法则求导
$$
\begin{aligned}
\frac{\part r}{\part t}&=\frac{\part r}{\|\boldsymbol  X_u\|^2} \left(\frac{\|\boldsymbol  X_u\|^2}{\part  x_u} \frac{\part x_u}{\part t}+ \frac{\|\boldsymbol  X_u\|^2}{\part y_u} \frac{\part y_u}{\part t}+\frac{\|\boldsymbol  X_u\|^2}{\part  z_u} \frac{\part z_u}{\part t} \right) \\
\frac{\part r}{\part s}&=\frac{\part r}{\|\boldsymbol  X_u\|^2} \left(\frac{\|\boldsymbol  X_u\|^2}{\part  x_u} \frac{\part x_u}{\part s}+ \frac{\|\boldsymbol  X_u\|^2}{\part y_u} \frac{\part y_u}{\part s}+\frac{\|\boldsymbol  X_u\|^2}{\part  z_u} \frac{\part z_u}{\part s} \right) \\
\frac{\part r}{\part b}&=\frac{\part r}{\|\boldsymbol  X_u\|^2} \left(\frac{\|\boldsymbol  X_u\|^2}{\part  x_u} \frac{\part x_u}{\part b}+ \frac{\|\boldsymbol  X_u\|^2}{\part y_u} \frac{\part y_u}{\part b}+\frac{\|\boldsymbol  X_u\|^2}{\part  z_u} \frac{\part z_u}{\part b} \right) \\
\end{aligned} \tag{4}
$$
进一步有
$$
\begin{aligned}
\frac{\part r}{\part t_1} &= -\left( 2y_us_1(x-b_1)\right)   \\
\frac{\part r}{\part t_2} &= -\left( -2z_us_1(x-b_1)\right)  \\
\frac{\part r}{\part t_3} &= -\left( 2z_us_2(y-b_2)\right)  \\
\end{aligned} \tag{5}
$$

$$
\begin{aligned}
\frac{\part r}{\part s_1} &= -\left( 2x_u(x-b_1)+2y_ut_1(x-b_1)-2z_ut_2(x-b_1)\right)  \\
\frac{\part r}{\part s_2} &= -\left( 2y_u(y-b_2) +2z_ut_3(y-b_2)\right)  \\
\frac{\part r}{\part s_3} &= -\left( 2z_u(z-b_3)\right)  \\
\end{aligned} \tag{6}
$$

$$
\begin{aligned}
\frac{\part r}{\part b_1} &= -\left( 2x_u(-s_1)+2y_u(-s_1t_1)-2z_u(-s_1t_2)\right)  \\
\frac{\part r}{\part b_2} &= -\left( 2y_u(-s_2)+2z_u(-s_2t_3)\right)  \\
\frac{\part r}{\part b_3} &= -\left( 2z_u(-s_3)\right)  \\
\end{aligned} \tag{7}
$$

